name: Repository_versioning

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  tag-and-version:
    # Only run when the PR was merged
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # Initial Summary (ALWAYS RUNS)
      - name: Initial run summary
        id: initial_summary
        shell: bash
        run: |
          REPO="${{ github.repository }}"
          SERVER_URL="${{ github.server_url }}"
          RUN_ID="${{ github.run_id }}"
          RUN_NUMBER="${{ github.run_number }}"
          EVENT_NAME="${{ github.event_name }}"
          PR_NUMBER="${{ github.event.pull_request.number || '' }}"
          ACTOR="${{ github.actor }}"
          HEAD_REF="${{ github.head_ref || '' }}"
          BASE_REF="${{ github.base_ref || '' }}"
          {
            echo "## repository-auto-versioning — Initial Context"
            echo "- Repository: ${REPO}"
            echo "- Run: ${SERVER_URL}/${REPO}/actions/runs/${RUN_ID} (#${RUN_NUMBER})"
            echo "- Trigger: ${EVENT_NAME}"
            echo "- Actor: ${ACTOR}"
            if [ -n "${PR_NUMBER}" ] && [ "${PR_NUMBER}" != "null" ]; then
              echo "- PR: #${PR_NUMBER} (${HEAD_REF} → ${BASE_REF})"
            fi
            echo "- Next step: skip-ci detection"
          } >> "$GITHUB_STEP_SUMMARY"

      # Full "Skip CI" detection (title/body/commits)
      - name: Full Skip CI Check (title, body, commits)
        id: check_skip
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.pull_request.number || '' }}"
          OWNER_REPO="${{ github.repository }}"
          echo "Checking PR #${PR_NUMBER} for skip markers (title / body / commits)..."

          contains_skip() {
            # Accept common variants: [skip ci], skip-ci, skip_ci, skip ci (case-insensitive)
            echo "$1" | grep -qiE '\[?skip[ _-]?ci\]?'
          }

          # default outputs so step always has outputs
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "skip_where=none" >> $GITHUB_OUTPUT
          # Check PR title & body
          if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "${GITHUB_EVENT_PATH}" ]; then
            PR_TITLE=$(jq -r '.pull_request.title // ""' "${GITHUB_EVENT_PATH}" 2>/dev/null || echo "")
            PR_BODY=$(jq -r '.pull_request.body // ""' "${GITHUB_EVENT_PATH}" 2>/dev/null || echo "")
            echo "PR title: ${PR_TITLE}"
            echo "PR body: (length) $(printf "%s" "$PR_BODY" | wc -c) chars"

            if contains_skip "$PR_TITLE"; then
              echo "Found skip marker in PR title."
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "skip_where=title" >> $GITHUB_OUTPUT
              exit 0
            fi

            if contains_skip "$PR_BODY"; then
              echo "Found skip marker in PR body."
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "skip_where=body" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Check each commit message in the PR using GitHub API
          echo "Fetching commits for PR via GitHub API..."
          commits_json=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER_REPO}/pulls/${PR_NUMBER}/commits" || true)

          # If API returned JSON array, inspect commit messages; otherwise warn and skip commit-level checks.
          first_char="$(printf '%s' "$commits_json" | head -c 1 || echo '')"
          if [ "$first_char" = "[" ]; then
            printf '%s' "$commits_json" | jq -r '.[].commit.message' | while IFS= read -r msg; do
              if contains_skip "$msg"; then
                echo "Found skip marker in PR commit message"
                echo "skip=true" >> $GITHUB_OUTPUT
                echo "skip_where=commit" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
          else
            echo "Warning: commits API returned non-array (or error). Skipping commit-level skip-ci detection."
            echo "commits_api_head: ${commits_json:0:200}"
          fi

      # Skip Notice (if skip ci=true)
      - name: Skip notice (when skip ci=true)
        if: ${{ steps.check_skip.outputs.skip == 'true' }}
        shell: bash
        run: |
          {
            echo "## repository-auto-versioning — Skipped"
            echo "- Reason: skip-ci marker detected"
            echo "- Location: ${{ steps.check_skip.outputs.skip_where }}"
            echo "- Composite action was not executed."
          } >> "$GITHUB_STEP_SUMMARY"

      # Configure Git for private modules
      - name: Configure Git for private modules
        if: ${{ steps.check_skip.outputs.skip == 'false' }}
        id: private_auth
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          private_status="missing"
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            # replace github.com with x-access-token URL so subsequent 'git' fetches can access private repos
            git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
            private_status="configured"
          fi
          echo "private_git_auth=${private_status}" >> $GITHUB_OUTPUT

      # Private auth summaries (success / failure)
      - name: Private auth success summary
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.private_auth.outcome == 'success' }}
        shell: bash
        run: |
          AUTH="${{ steps.private_auth.outputs.private_git_auth || 'unknown' }}"
          {
            echo "## repository-auto-versioning — Private Git config"
            echo "- Private module auth: ${AUTH}"
            echo "- Private auth step: succeeded"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Private auth failure summary
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.private_auth.outcome != 'success' }}
        shell: bash
        run: |
          AUTH="${{ steps.private_auth.outputs.private_git_auth || 'missing' }}"
          {
            echo "## repository-auto-versioning — Private Git config"
            echo "- Private module auth: ${AUTH}"
            echo "- Private auth step: FAILED"
            echo "- Note: Without configured private git auth, composite action may fail to fetch private modules or action code from other org repos."
            echo "- Tip: ensure the `GITHUB_TOKEN` or a PAT secret is available and the workflow has permission to use it."
          } >> "$GITHUB_STEP_SUMMARY"
      # 5) Pre-call composite summary
      - name: Pre-call summary for composite action repository-auto-version
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.private_auth.outcome == 'success' }}
        shell: bash
        run: |
          {
            echo "## repository-auto-versioning — Composite Start"
            echo "- Action: tool-ims/ims_tool-github-shared_actions/.github/actions/repository-auto-versioning"
            echo "- PR: #${{ github.event.pull_request.number }}"
            # try get current version from repo file if exists
            if [ -f version ]; then
              echo "- Current version (repo file): $(cat version | tr -d '\r\n')"
            else
              echo "- Current version: unknown (no version file)"
            fi
            echo "- Next: running composite action to compute new version"
          } >> "$GITHUB_STEP_SUMMARY"
      # Run composite repository-auto-versioning if NOT skipped and private_auth succeeded
      - name: Run repository-auto-versioning
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.private_auth.outcome == 'success' }}
        id: tagger
        uses: .github/actions/repository-auto-versioning    # <- replace with your published composite action@tag
        # format: uses: <owner>/<repo>[/<path-to-action>]@<ref> Ex: uses: my-org/shared-repo/.github/actions/git-auto-version@v1.0.0
        with:
          pr_number: ${{ github.event.pull_request.number }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # Repo-level result summary (on success of tagger)
      - name: Repo-level result summary (on success)
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.tagger.outcome == 'success' }}
        shell: bash
        run: |
          TAG="${{ steps.tagger.outputs.new_version || '' }}"
          UPDATE_TYPE="${{ steps.tagger.outputs.update_type || 'unknown' }}"
          {
            echo "## repository-auto-versioning — Result"
            echo "- Status: SUCCESS"
            if [ -n "${TAG}" ]; then
              echo "- Created tag: ${TAG}"
              echo "- Update type: ${UPDATE_TYPE}"
            else
              echo "- No tag created (unexpected). Check composite action logs."
            fi
            echo "- Composite action appended detailed summary."
            echo "- Tip: enable upload_logs: 'true' to capture /tmp/ci_versioning.log as an artifact for debugging."
          } >> "$GITHUB_STEP_SUMMARY"
      # Repo-level result summary (on failure of tagger)
      - name: Repo-level result summary (on failure)
        if: ${{ steps.check_skip.outputs.skip == 'false' && steps.tagger.outcome != 'success' }}
        shell: bash
        run: |
          {
            echo "## repository-auto-versioning — Result"
            echo "- Status: FAILED"
            echo "- The repository-auto-versioning composite action failed. See the composite step logs for details."
            echo "- Consider re-running with 'upload_logs: true' to capture debug artifact (/tmp/ci_versioning.log)."
          } >> "$GITHUB_STEP_SUMMARY"