name: Terraform Module

on:
  workflow_call:
    inputs:
      workload_tower:
        description: Workload tower (tu, int, cust, sec, coll, comm, fin)
        required: true
        type: string
      application:
        description: Application, service, or module name
        required: true
        type: string
      environment:
        description: Environment (dev, tst, ppe, prd)
        required: true
        type: string
      sub_environment:
        description: >
          Encoded sub-environment.
          prd → prb | prg
          ppe → ppb | ppg
          tst → sta | stb
        required: false
        type: string
      region:
        description: Execution or deployment region
        required: true
        type: string
        default: "eu-west-1"
      working_directory:
        description: Terraform module directory
        required: true
        type: string
      action:
        description: Terraform action
        required: true
        type: string
        default: apply
      backend_config_file:
        description: Backend config file (relative to working_directory)
        required: true
        type: string
      var_file:
        description: Optional tfvars file (relative to working directory)
        required: true
        type: string
  workflow_dispatch:
    inputs:
      workload_tower:
        description: Workload tower (tu, int, cust, sec, coll, comm, fin)
        required: true
        default: "."
        type: choice
        options: [tu, int, cust, sec, coll, comm, fin]
      application:
        description: Application, service, or module name
        required: true
        default: ""
      environment:
        description: Environment (dev, tst, ppe, prd)
        required: true
        type: choice
        options: [dev, tst, ppe, prd]
      sub_environment:
        description: >
          Encoded sub-environment.
          prd → prb | prg
          ppe → ppb | ppg
          tst → sta | stb
        required: false
        default: ""
      region:
        description: Execution or deployment region
        required: true
        default: "eu-west-1"
      working_directory:
        description: Terraform module directory
        required: true
      action:
        description: Terraform action
        required: true
        type: choice
        options: [plan, apply, plan-destroy, apply-destroy]
      backend_config_file:
        description: Backend config file (relative to working_directory)
        required: true
        default: ""
      var_file:
        description: Optional tfvars file (relative to working directory)
        required: true
        default: ""

permissions:
  contents: read
  id-token: write

concurrency:
  group: terraform-${{ inputs.working_directory }}-${{ github.ref }}
  cancel-in-progress: false

# --------------------------------------------------
# PLAN (runs for plan + apply)
# --------------------------------------------------
jobs:
  plan:
    name: Plan
    if: ${{ inputs.action == 'plan' || inputs.action == 'apply' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    outputs:
      plan_status: ${{ steps.plan.outputs.plan_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print run context
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/print-run-context@main
        with:
          title: Terraform plan
          workload_tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          sub_environment: ${{ inputs.sub_environment }}
          application: ${{ inputs.application }}
          action: plan
          region: ${{ inputs.region }}
          working_directory: ${{ inputs.working_directory }}

      - name: AWS authentication (OIDC)
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-auth-oidc@main
        with:
          target_account_id: ${{ steps.account.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup@main
        with:
          working_directory: ${{ inputs.working_directory }}
          backend_config_file: ${{ inputs.backend_config_file }}

      - name: Terraform plan
        id: plan
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-plan@main
        with:
          working_directory: ${{ inputs.working_directory }}
          environment: ${{ inputs.environment }}
          var_file: ${{ inputs.var_file }}

# --------------------------------------------------
# APPLY (ONLY IF CHANGES + WITH APPROVAL GATE)
# --------------------------------------------------
  apply:
    if: >
      ${{
        inputs.action == 'apply' &&
        needs.plan.outputs.plan_status == 'changes'
      }}
    needs: plan
    runs-on: ubuntu-latest
    # Approval gate using GitHub Environments
    environment: ${{ format('{0}-deploy', inputs.environment) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print run context
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/print-run-context@main
        with:
          title: Terraform apply
          workload_tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          sub_environment: ${{ inputs.sub_environment }}
          application: ${{ inputs.application }}
          action: apply
          region: ${{ inputs.region }}
          working_directory: ${{ inputs.working_directory }}

      - name: AWS authentication (OIDC)
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-auth-oidc@main
        with:
          target_account_id: ${{ steps.account.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup@main
        with:
          working_directory: ${{ inputs.working_directory }}
          backend_config_file: ${{ inputs.backend_config_file }}

      - name: Download Terraform plan artifact
        uses: actions/download-artifact@v4
        with:
          name: plan-${{ inputs.environment }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}

      - name: Terraform apply
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-apply@main
        with:
          working_directory: ${{ inputs.working_directory }}
          plan_file: ${{ inputs.working_directory }}/plan-${{ inputs.environment }}.tfplan

# --------------------------------------------------
# PLAN DESTROY
# --------------------------------------------------
  plan-destroy:
    if: ${{ inputs.action == 'plan-destroy' || inputs.action == 'apply-destroy' }}
    runs-on: ubuntu-latest
    outputs:
      plan_status: ${{ steps.plan.outputs.plan_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print run context
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/print-run-context@main
        with:
          title: Terraform destroy plan
          workload_tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          sub_environment: ${{ inputs.sub_environment }}
          application: ${{ inputs.application }}
          action: plan-destroy
          region: ${{ inputs.region }}
          working_directory: ${{ inputs.working_directory }}

      - name: AWS authentication (OIDC)
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-auth-oidc@main
        with:
          target_account_id: ${{ steps.account.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup@main
        with:
          working_directory: ${{ inputs.working_directory }}
          backend_config_file: ${{ inputs.backend_config_file }}

      - name: Terraform plan destroy
        id: plan
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-plan-destroy@main
        with:
          working_directory: ${{ inputs.working_directory }}
          environment: ${{ inputs.environment }}
          var_file: ${{ inputs.var_file }}

# --------------------------------------------------
# APPLY DESTROY (ONLY IF CHANGES + APPROVAL GATE)
# --------------------------------------------------
  apply-destroy:
    if: >
      ${{
        inputs.action == 'apply-destroy' &&
        needs.plan-destroy.outputs.plan_status == 'changes'
      }}
    needs: plan-destroy
    runs-on: ubuntu-latest
    environment: ${{ format('{0}-deploy', inputs.environment) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print run context
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/print-run-context@main
        with:
          title: Terraform destroy apply
          workload_tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          sub_environment: ${{ inputs.sub_environment }}
          application: ${{ inputs.application }}
          action: destroy
          region: ${{ inputs.region }}
          working_directory: ${{ inputs.working_directory }}

      - name: AWS authentication (OIDC)
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/aws-auth-oidc@main
        with:
          target_account_id: ${{ steps.account.outputs.account_id }}
          tower: ${{ inputs.workload_tower }}
          environment: ${{ inputs.environment }}
          region: ${{ inputs.region }}

      - name: Terraform setup
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-setup@main
        with:
          working_directory: ${{ inputs.working_directory }}
          backend_config_file: ${{ inputs.backend_config_file }}

      - name: Download Terraform destroy plan artifact
        uses: actions/download-artifact@v4
        with:
          name: destroy-plan-${{ inputs.environment }}-${{ github.run_id }}
          path: ${{ inputs.working_directory }}

      - name: Terraform apply destroy
        uses: tool-ims/ims_tool-github-shared_actions/.github/actions/terraform-apply-destroy@main
        with:
          working_directory: ${{ inputs.working_directory }}
          plan_file: ${{ inputs.working_directory }}/destroy-plan-${{ inputs.environment }}.tfplan